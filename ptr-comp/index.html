<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/luffy.img?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/luffy.img?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/luffy.img?v=5.1.3"><link rel="mask-icon" href="/images/luffy.img?v=5.1.3" color="#222"><meta name="keywords" content="Performance,"><meta name="description" content="目前仅比对github上star数&amp;gt;1500的下拉刷新开源库，在比较完成之后可能会加入其它有代表性的库. 本文的demo可以在github上找到。"><meta name="keywords" content="Performance"><meta property="og:type" content="article"><meta property="og:title" content="安卓下拉刷新开源库对比"><meta property="og:url" content="http://blog.desmondyao.com/ptr-comp/index.html"><meta property="og:site_name" content="Desmond&#39;s Blog"><meta property="og:description" content="目前仅比对github上star数&amp;gt;1500的下拉刷新开源库，在比较完成之后可能会加入其它有代表性的库. 本文的demo可以在github上找到。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/chrisbanes.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/liaohuqiu.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/johan.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/yalantis.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/flyrefresh.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/swipe.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/chrisbanes_scroll.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/swipe_scroll.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/liaohuqiu_scroll.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/trace_operation.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/chrisbanes.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/liaohuqiu.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/liaohuqiu_ptr_header.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/liaohuqiu_new.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/johan.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/yalantis.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/yalantis_back.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/yalantis_padding.webp"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/yalantis_back_new.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/flyrefresh.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/swipe.PNG"><meta property="og:image" content="http://blog.desmondyao.com/image/ptr-comp/swipe_new.PNG"><meta property="og:updated_time" content="2017-11-15T15:27:41.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="安卓下拉刷新开源库对比"><meta name="twitter:description" content="目前仅比对github上star数&amp;gt;1500的下拉刷新开源库，在比较完成之后可能会加入其它有代表性的库. 本文的demo可以在github上找到。"><meta name="twitter:image" content="http://blog.desmondyao.com/image/ptr-comp/chrisbanes.webp"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://blog.desmondyao.com/ptr-comp/"><title>安卓下拉刷新开源库对比 | Desmond's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Desmond's Blog</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Focus on Java, Android, React Native.</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://blog.desmondyao.com/ptr-comp/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Desmond Yao"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Desmond's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">安卓下拉刷新开源库对比</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-06T20:30:53+08:00">2017-11-06</time></span></div></header><div class="post-body" itemprop="articleBody"><p>目前仅比对github上star数&gt;1500的下拉刷新开源库，在比较完成之后可能会加入其它有代表性的库. 本文的demo可以在<a href="https://github.com/desmond1121/Android-Ptr-Comparison" target="_blank" rel="external">github</a>上找到。</p><a id="more"></a><h2 id="Repo"><a href="#Repo" class="headerlink" title="Repo"></a>Repo</h2><table><thead><tr><th style="text-align:center">Repo</th><th style="text-align:center">Owner</th><th style="text-align:center">Star<br>(2015.12.5)</th><th style="text-align:center">version</th><th style="text-align:center">Snap shot</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://github.com/chrisbanes/Android-PullToRefresh" target="_blank" rel="external">Android-PullToRefresh</a><br>(作者已停止维护)</td><td style="text-align:center"><a href="https://github.com/chrisbanes" target="_blank" rel="external">chrisbanes</a></td><td style="text-align:center">6014</td><td style="text-align:center">latest</td><td style="text-align:center"><img src="/image/ptr-comp/chrisbanes.webp" alt="chrisbanes"></td></tr><tr><td style="text-align:center"><a href="https://github.com/liaohuqiu/android-Ultra-Pull-To-Refresh" target="_blank" rel="external">android-Ultra-Pull-To-Refresh</a></td><td style="text-align:center"><a href="https://github.com/liaohuqiu" target="_blank" rel="external">liaohuqiu</a></td><td style="text-align:center">3413</td><td style="text-align:center">1.0.11</td><td style="text-align:center"><img src="/image/ptr-comp/liaohuqiu.webp" alt="liaohuqiu"></td></tr><tr><td style="text-align:center"><a href="https://github.com/johannilsson/android-pulltorefresh" target="_blank" rel="external">android-pulltorefresh</a><br>(作者已停止维护)</td><td style="text-align:center"><a href="https://github.com/johannilsson" target="_blank" rel="external">johannilsson</a></td><td style="text-align:center">2414</td><td style="text-align:center">latest</td><td style="text-align:center"><img src="/image/ptr-comp/johan.webp" alt="johannilsson"></td></tr><tr><td style="text-align:center"><a href="https://github.com/Yalantis/Phoenix" target="_blank" rel="external">Phoenix</a></td><td style="text-align:center"><a href="https://github.com/Yalantis" target="_blank" rel="external">Yalantis</a></td><td style="text-align:center">1897</td><td style="text-align:center">1.2.3</td><td style="text-align:center"><img src="/image/ptr-comp/yalantis.webp" alt="yalantis"></td></tr><tr><td style="text-align:center"><a href="https://github.com/race604/FlyRefresh" target="_blank" rel="external">FlyRefresh</a></td><td style="text-align:center"><a href="https://github.com/race604" target="_blank" rel="external">race604</a></td><td style="text-align:center">1843</td><td style="text-align:center">2.0.0</td><td style="text-align:center"><img src="/image/ptr-comp/flyrefresh.webp" alt="flyrefresh"></td></tr><tr><td style="text-align:center"><a href="http://developer.android.com/reference/android/support/v4/widget/SwipeRefreshLayout.html" target="_blank" rel="external">SwipeRefreshLayout</a></td><td style="text-align:center">Android<br>Support v4<br>(19.1.0 ↑)</td><td style="text-align:center">None</td><td style="text-align:center">latest</td><td style="text-align:center"><img src="/image/ptr-comp/swipe.webp" alt="swipe_refresh"></td></tr></tbody></table><h2 id="拓展性"><a href="#拓展性" class="headerlink" title="拓展性"></a>拓展性</h2><table><thead><tr><th style="text-align:center">Repo</th><th style="text-align:center">自定义顶部视图</th><th style="text-align:center">支持的内容布局</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://github.com/chrisbanes/Android-PullToRefresh" target="_blank" rel="external">Android-PullToRefresh</a></td><td style="text-align:center">不支持，只能改代码。<br>由于仅支持其中实现的<code>LoadingLayout</code>作为顶视图，改代码实现自定义工作量较大。</td><td style="text-align:center">任意视图，内置:<code>GridView</code><br><code>ListView</code>,<code>HorizontalScrollView</code><br><code>ScrollView</code> ,<code>WebView</code></td></tr><tr><td style="text-align:center"><a href="https://github.com/liaohuqiu/android-Ultra-Pull-To-Refresh" target="_blank" rel="external">android-Ultra-Pull-To-Refresh</a></td><td style="text-align:center">任意视图。<br>通过继承<code>PtrUIHandler</code>并调用<br><code>PtrFrameLayout.addPtrUIHandler()</code>得到最大支持。</td><td style="text-align:center">任意视图</td></tr><tr><td style="text-align:center"><a href="https://github.com/johannilsson/android-pulltorefresh" target="_blank" rel="external">android-pulltorefresh</a></td><td style="text-align:center">不支持，只能改代码。<br>代码仅一个<code>ListView</code>，耦合度太高，改动工作量较大。</td><td style="text-align:center">无法扩展，自身为<code>ListView</code></td></tr><tr><td style="text-align:center"><a href="https://github.com/Yalantis/Phoenix" target="_blank" rel="external">Phoenix</a></td><td style="text-align:center">不支持，此控件特点就是顶部视图及动画。</td><td style="text-align:center">任意视图，只显示最后一个嵌套的子视图。</td></tr><tr><td style="text-align:center"><a href="https://github.com/race604/FlyRefresh" target="_blank" rel="external">FlyRefresh</a></td><td style="text-align:center">不支持，此控件特点就是顶部视图及动画。</td><td style="text-align:center">任意视图</td></tr><tr><td style="text-align:center"><a href="http://developer.android.com/reference/android/support/v4/widget/SwipeRefreshLayout.html" target="_blank" rel="external">SwipeRefreshLayout</a></td><td style="text-align:center">不支持，固定为Material风格</td><td style="text-align:center">任意视图</td></tr></tbody></table><p>在拓展性的评价上, 谢谢<a href="https://github.com/XavierSAndroid" target="_blank" rel="external">@XavierSAndroid</a>同学提的的<a href="https://github.com/desmond1121/Android-Ptr-Comparison/issues/3" target="_blank" rel="external">建议</a>:</p><blockquote><p>由于下拉刷新已经较为偏离Google所『设定』的方向，所以在讨论这样的下拉刷新就隐含了『不局限于Google希望的风格』的前提。所以，从不拘泥于Android风格的设计上讲，用户体验方面，还有一个很重要的『内部滚动衔接外部OverScroll的处理』。这也是很关键的：第一次滑到顶骤停了，再拉才可以下拉刷新；和一次滑就能看到头部。用户体验差距是巨大的。至少，提供给开发者，开发者可以选择不用。</p></blockquote><h2 id="易用性"><a href="#易用性" class="headerlink" title="易用性"></a>易用性</h2><table><thead><tr><th style="text-align:center">Repo</th><th style="text-align:center">可在gradle配置</th><th style="text-align:center">上拉加载</th><th style="text-align:center">自动加载</th><th style="text-align:center">滑动阻尼配置</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://github.com/chrisbanes/Android-PullToRefresh" target="_blank" rel="external">Android-PullToRefresh</a></td><td style="text-align:center">×</td><td style="text-align:center">√</td><td style="text-align:center">×</td><td style="text-align:center">移动比固定1/2</td></tr><tr><td style="text-align:center"><a href="https://github.com/liaohuqiu/android-Ultra-Pull-To-Refresh" target="_blank" rel="external">android-Ultra-Pull-To-Refresh</a></td><td style="text-align:center">√</td><td style="text-align:center">×</td><td style="text-align:center">√</td><td style="text-align:center">√</td></tr><tr><td style="text-align:center"><a href="https://github.com/johannilsson/android-pulltorefresh" target="_blank" rel="external">android-pulltorefresh</a></td><td style="text-align:center">×</td><td style="text-align:center">×</td><td style="text-align:center">×</td><td style="text-align:center">移动比固定1/1.7</td></tr><tr><td style="text-align:center"><a href="https://github.com/Yalantis/Phoenix" target="_blank" rel="external">Phoenix</a></td><td style="text-align:center">√</td><td style="text-align:center">×</td><td style="text-align:center">×</td><td style="text-align:center">移动比固定1/2</td></tr><tr><td style="text-align:center"><a href="https://github.com/race604/FlyRefresh" target="_blank" rel="external">FlyRefresh</a></td><td style="text-align:center">√</td><td style="text-align:center">×</td><td style="text-align:center">×</td><td style="text-align:center">×</td></tr><tr><td style="text-align:center"><a href="http://developer.android.com/reference/android/support/v4/widget/SwipeRefreshLayout.html" target="_blank" rel="external">SwipeRefreshLayout</a></td><td style="text-align:center">√</td><td style="text-align:center">×</td><td style="text-align:center">×</td><td style="text-align:center">移动比固定1/2</td></tr></tbody></table><h2 id="触屏事件分发"><a href="#触屏事件分发" class="headerlink" title="触屏事件分发"></a>触屏事件分发</h2><p>本节分析控件对于<strong>触屏事件的分发以及处理拖动的时机</strong>，具体<strong>拖动实现</strong>将在下一节<a href="#性能分析">性能分析</a>中介绍。</p><p>此处添加进一个可以横滑的组件，并将所有组件中的<code>ListView</code>替换为自己实现的<code>ClassicListView</code>，重写控件<code>dispatchTouchEvent</code>, <code>onTouchEvent</code>来观察事件的处理传递。举几个典型：</p><h3 id="1-Chris-Banes’-ptr"><a href="#1-Chris-Banes’-ptr" class="headerlink" title="1. Chris Banes’ ptr"></a>1. Chris Banes’ ptr</h3><p><strong>触屏分发</strong>：</p><ul><li><code>dispatchTouchEvent</code> 没有处理。</li><li><code>onInterceptTouchEvent</code> 返回结果为<code>mIsBeingDragged</code>。<ul><li><code>DOWN</code> 不拦截。若可以拉动，更新<code>mIsBeingDragged</code>为<code>false</code>；</li><li><code>MOVE</code> 正在更新时直接拦截，如果拉动模式方向（竖直or水平）上的移动更多则将<code>mIsBeingDragged</code>置为<code>true</code>（反之不会置为<code>false</code>）。</li><li><code>UP/CANCEL</code> 不拦截，更新<code>mIsBeingDragged</code>为false。</li></ul></li><li><code>onTouchEvent</code> （此阶段处理UI拖动逻辑）<ul><li><code>DOWN</code> 此时可以拉动刷新时消耗该event（返回<code>true</code>），否则返回<code>false</code>；</li><li><code>MOVE</code> <code>mIsBeingDragged</code>为<code>true</code>时消耗该event（返回<code>true</code>），否则返回<code>false</code>；</li><li><code>UP/CANCEL</code> <code>mIsBeingDragged</code>为<code>true</code>时，消耗该event（返回<code>true</code>），否则返回<code>false</code>。</li></ul></li></ul><p><strong>分析</strong>：</p><p>在<code>onTouchEvent</code>阶段处理了UI移动逻辑，且dispatch阶段不处理分发逻辑。配合此处intercept的处理，有两种情况：</p><ul><li>最开始横滑，则不拦截，并且<code>`mIsBeingDragged</code>为<code>false</code>时，<code>onTouchEvent</code>没有消耗此次事件，则此次不会再交给自己处理，它现在只有dispatch的功能，无法进行下拉、上拉的拖动；于是可以这么说：横滑事件一旦进行，就<strong>无法触发上拉、下拉刷新</strong>。</li><li>最开始竖滑，则可以拉动时，事件将被截断，并<code>onTouchEvent</code>返回<code>true</code>消耗该事件，无法分发到下层View，始终交由自身处理。</li></ul><p><strong>触屏事件示例</strong>：</p><p><img src="/image/ptr-comp/chrisbanes_scroll.webp" alt="chrisbanes_scroll"></p><h3 id="2-SwipeRefreshLayout"><a href="#2-SwipeRefreshLayout" class="headerlink" title="2. SwipeRefreshLayout"></a>2. SwipeRefreshLayout</h3><p><strong>触屏分发</strong>：</p><ul><li><code>dispatchTouchEvent</code> 没有处理。</li><li><code>onInterceptTouchEvent</code> 如果此时无法触发刷新，直接返回<code>false</code>；其他情况返回结果为<code>mIsBeingDragged</code>:<ul><li><code>DOWN</code> 更新<code>mIsBeingDragged</code>为<code>false</code>，不拦截；</li><li><code>MOVE</code> 只要竖向移动偏移量大于<code>TouchSlop</code>则拦截，更新<code>mIsBeingDragged</code>为<code>true</code>；</li><li><code>UP/CANCEL</code> 不拦截，更新<code>mIsBeingDragged</code>为false。</li></ul></li><li><code>onTouchEvent</code> （此阶段处理UI拖动逻辑）<ul><li><code>DOWN</code> 消耗event（返回<code>true</code>）；</li><li><code>MOVE</code> 仅仅当移动回顶部后再移动时不消耗，其他情况均消耗event（返回<code>true</code>）；</li><li><code>UP/CANCEL</code> 不消耗。</li></ul></li></ul><p><strong>分析</strong>：</p><p>与Chris Banes一样，处理方式都是重写<code>onInterceptTouchEvent</code> + <code>onTouchEvent</code>，不过效果却完全不同。究其原因，主要是它没有对水平、竖直冲突时做判断，并且<code>onTouchEvent</code>中除个别情况外都返回<code>true</code>，即消耗了这个事件。所以<strong>只要能够刷新时，无论事件是否被底层view消耗，刷新动作一定会截断事件分发</strong>。</p><p><strong>触屏事件示例</strong>：</p><p><img src="/image/ptr-comp/swipe_scroll.webp" alt="swipe_scroll"></p><h3 id="3-Liaohuqiu’s-ptr"><a href="#3-Liaohuqiu’s-ptr" class="headerlink" title="3. Liaohuqiu’s ptr"></a>3. Liaohuqiu’s ptr</h3><p><strong>触屏分发</strong>：</p><ul><li><code>dispatchTouchEvent</code> （此阶段处理UI拖动逻辑）<ul><li><code>DOWN</code> 手动调用<code>super.dispatchTouchEvent()</code>将事件传递下去，但之后直接返回<code>true</code>，保证后续能够处理到move、up、cancel事件；</li><li><code>MOVE</code> 被拉动时直接返回<code>true</code>，不向下传递事件；没有被拉动、无法触发拉动时不处理，传递给下层view。若设置了<code>disableWhenHorizontalMove</code>，则在没有被拉动时的横滑操作直接传递给下层view；</li><li><code>UP/CANCEL</code> 如果被拖动了，则直接返回<code>true</code>，截断了此次事件，并手动向下层传递一个cancel事件；否则直接传递给下层view。</li></ul></li><li><code>onInterceptTouchEvent</code> 没有处理</li><li><code>onTouchEvent</code> 没有处理</li></ul><p><strong>分析</strong>：</p><p>dispatch阶段直接处理了分发逻辑与UI移动逻辑。只要它自身或它的子view处理了事件，dispatch永远会被触发，且它down时永远返回<code>true</code>。那么可以说：只要满足能够下拉的情况（对于<code>ListView</code>，默认为第一项完全可见）时，<strong>下拉刷新动作一定会被触发</strong>。一旦拉动，会在<code>updatePos</code>里面向下层view传递一个cancel事件，下层将会不再处理此次事件序列(原因可见<code>View.dispatchTouchEvent()</code> -&gt; <code>InputEventConsistencyVerifier.onTouchEvent()</code>)。</p><p>所以如果内部有冲突的滑动事件处理机制（典型就是嵌套横滑），那么只要一进行刷新拉动，内部的事件处理马上就会被截断。与Chris Banes的下拉刷新处理机制（内部消耗事件时外部无法拉动）不一样。</p><p><strong>触屏事件示例</strong>：</p><p><img src="/image/ptr-comp/liaohuqiu_scroll.webp" alt="liaohuqiu_scroll"></p><h3 id="3-其他库"><a href="#3-其他库" class="headerlink" title="3.其他库"></a>3.其他库</h3><p>基本的做法就是如上两种。以下不再赘述，由于<code>ListView</code>一定会消耗事件，如果是<strong>嵌套视图</strong>的话必须重写<code>onInterceptTouchEvent</code>+<code>onTouchEvent</code>或者直接重写<code>dispatchTouchEvent</code>才能够保证正确接收并处理到触摸事件。两种写法各有利弊，我个人认为重写<code>onInterceptTouchEvent</code> + <code>onTouchEvent</code>更加灵活。下面简单列出余下库的做法：</p><ul><li><strong>Johannilsson’s ptr</strong> 没有嵌套，直接处理<code>onTouchEvent</code>；</li><li><strong>Yalantis’s ptr</strong> 嵌套视图，处理类似Chris banes’ ptr；</li><li><strong>race604’s ptr</strong> 嵌套视图，处理类似Chris banes’ ptr；</li></ul><p>##性能分析</p><p>通过捕捉如下图中的操作持续1秒钟的systrace进行性能分析：</p><p><img src="/image/ptr-comp/trace_operation.webp" alt="trace_operation"></p><blockquote><p>注：由于开源库Header大多无法直接放自定义顶部视图，头部视图复杂程度不同，数据对比结果会有所偏差。</p></blockquote><h3 id="1-Chris-Banes’s-Ptr"><a href="#1-Chris-Banes’s-Ptr" class="headerlink" title="1. Chris Banes’s Ptr"></a>1. Chris Banes’s Ptr</h3><p>滑动实现方式：触摸造成的下拉均是<code>View.scrollTo()</code>实现的；在松手之后，<code>View.post(Runnable)</code>触发<code>Runnable</code>执行回滚动画，在滑回原处之前不断<code>post</code>自己，并配合<code>Interpolator</code>执行<code>scrollTo()</code>进行滚动。</p><p>trace snapshot:</p><p><img src="/image/ptr-comp/chrisbanes.PNG" alt="trace_chrisbanes"></p><p><strong>分析</strong>：</p><p>作为Github上星星数最多的Android下拉刷新控件，从性能上看（渲染时间构成）几乎没有什么明显的缺点。可惜的是作者已经不再维护，顶部视图的扩展性比较差，并且gradle中也无法使用。在本次demo这类层级比较简单的环境中，几乎都达到了60fps，可以与后面的trace对比。</p><h3 id="2-liaohuqiu’s-Ptr"><a href="#2-liaohuqiu’s-Ptr" class="headerlink" title="2. liaohuqiu’s Ptr"></a>2. liaohuqiu’s Ptr</h3><p>滑动实现方式：触摸造成的下拉均是<code>View.offsetTopAndBottom()</code>实现的；在松手之后，触发<code>Scroller.startScroll()</code>计算回滚，使用<code>View.post(Runnable)</code>不停地监视<code>Scroller</code>的计算结果，从而实现视图变化(此处依然是<code>View.offsetTopAndBottom()</code>完成视图移动)。</p><p>trace snapshot:</p><p><img src="/image/ptr-comp/liaohuqiu.PNG" alt="trace_liaohuqiu"></p><p><strong>分析</strong>：</p><p>这套开源库可以说是自定义功能最强的组件了，你可以实现<code>PtrUIHandler</code>并将其add到<code>PtrFrameLayout</code>完美地与下拉刷新事件适配。美中不足的就是在下拉状态变化的时候会有一阵measure时间。我查看了一下代码，发现是<code>PtrClassicFrameLayout</code>（作者实现的集成默认下拉视图的layout）的顶部视图出了问题：</p><p><img src="/image/liaohuqiu_ptr_header.PNG" alt="liaohuqiu_header"></p><p>看！都是<code>wrap_content</code>，那么当里面的内容变化的时候，是会触发<code>View.requestLayout()</code>的。不要小看这一个子视图的小操作，一个<code>requestLayout()</code>大概是这么一个流程：<code>View.requestLayout()</code>-&gt;<code>ViewParent.requestLayout()</code>-&gt;…-&gt;<code>ViewRootImpl.requestLayout()</code>-&gt;<code>ViewRootImpl.doTraversal()</code>=&gt;<strong>MEASURE</strong>(ViewGroup)=&gt;<strong>MEASURE</strong>(ChildView of ViewGroup)</p><p>在层级复杂的时候（大部分互联网产品由于复杂的产品需求嵌套都会比较多），它会层层向上调用，将measure时间放大至一个可观的层级。下拉刷新界面的卡顿由此而来。</p><p>我修改了一下，将其全部变为固定高度、宽度，之后的trace如下：</p><p><img src="/image/ptr-comp/liaohuqiu_new.PNG" alt="trace_liaohuqiu_new"></p><p>measure时间神奇的没掉了吧:)</p><h3 id="3-johannilsson’s-Ptr"><a href="#3-johannilsson’s-Ptr" class="headerlink" title="3. johannilsson’s Ptr"></a>3. johannilsson’s Ptr</h3><p>滑动实现方式：初始时<code>setSelection(1)</code>隐藏顶部视图（使用这个下拉刷新控件注意将滚动栏隐藏，否则会露馅）。在拉下来超过header view的measure高度之前，均是<code>ListView</code>自有的滚动；在下拉超过header measure高度之后，对header使用<code>View.setPadding()</code>让header继续下移。</p><p>trace snapshot:</p><p><img src="/image/ptr-comp/johan.PNG" alt="trace_johan"></p><p><strong>分析</strong>：</p><p>通过顶视图调用<code>View.setPadding()</code>来实现的滑动，在下拉距离超过header高度后，会造成不断的<code>requestLayout()</code>!这就解释了为什么图中UI线程的蓝色块时间(measure时间)很明显。<strong>当你在视图层级比较复杂的app中使用它时，下拉动作所造成的开销会非常明显，卡顿是必然结果。</strong></p><h3 id="4-Yalantis’s-Ptr"><a href="#4-Yalantis’s-Ptr" class="headerlink" title="4. Yalantis’s Ptr"></a>4. Yalantis’s Ptr</h3><p>滑动实现方式：通过<code>View.topAndBottomOffset()</code>移动视图，在松手之后启动一个<code>Animation</code>执行回滚动画，内容视图的移动也使用<code>View.offsetTopAndBottom()</code>实现。为了保证子内容视图的底部padding在移动之后与布局文件中的padding属性一致，它额外调用了<code>View.setPadding()</code>实时设置padding。</p><p>顶部动效实现方式：<code>Drawable</code>的<code>draw()</code>中，为<code>Canvas</code>中设置“太阳”偏移量及背景缩放。</p><p>trace snapshot:</p><p><img src="/image/ptr-comp/yalantis.PNG" alt="trace_yalantis"></p><p><strong>分析</strong>：</p><p>此开源库动画效果非常柔和，且顶部视图全部是通过draw去更新，不会造成第三个开源库那样的大开销问题。可惜的是比较难以去自定义顶部视图，不好在线上产品中使用，不过这个开源库是一个好的练手与学习的对象。由于顶部动效实现开销不大，它的性能同样非常好。</p><p>它在松手后回滚时调用的<code>View.setPadding()</code>可能会造成measure开销比较大，于是我特地测了一下松手回滚的trace，一看确实measure时间非常可观：</p><p><img src="/image/ptr-comp/yalantis_back.PNG" alt="trace_yalantis_scroll_back"></p><p>确实它如果要保证展示内容视图的padding与布局文件中一致，是必须这么做的（调用<code>View.setPadding()</code>），因为通过<code>View.offsetTopAndBottom()</code>向下移动子视图时，子视图的内容整个移动下来，在视觉上会影响它设置好的底部padding。但是很有意思，它向下移动的时候没有这么设置，拉下来的时候底部padding就没了。回滚动画的时候才设了padding，就显得没那么必要了。我在demo中也进行了实践，确实是这样的：</p><p><img src="/image/ptr-comp/yalantis_padding.webp" alt="yalantis_padding"></p><p>我暂时也没想到什么方法可以更好地处理子视图padding问题。但实际上，由于这个库是一个嵌套视图，并且只会有一个内容视图显示出来，可以尝试放弃对子视图padding的处理。如果需要，可以使用父视图的padding来代替，这样是最完美的效果。子视图再怎么移动，也会被父视图已经设好的padding局限住。由此一来padding就不会被影响，同时提高了性能。不过这样一来牺牲了子视图padding的设置，在使用的时候可以根据需要各取所需。</p><p>我粗略的做了一点点改动，将它的<code>setPadding()</code>注释掉了。不过由于该库的一些其他实现逻辑，导致会有一些问题，此处仅看性能上的变化，改动后松手回滚trace，已经没有了measure时间：</p><p><img src="/image/ptr-comp/yalantis_back_new.PNG" alt="yalantis_back_trace_new"></p><h3 id="5-race604’s-Ptr"><a href="#5-race604’s-Ptr" class="headerlink" title="5. race604’s Ptr"></a>5. race604’s Ptr</h3><p>滑动实现方式：<code>View.topAndBottomOffset()</code></p><p>顶部动效实现方式：</p><ul><li><strong>飞机滑动</strong> <code>ObjectAnimator</code>.</li><li><strong>山体移动、树木弯曲</strong> 通过移动距离计算山体偏移、树木轮廓，得出<code>Path</code>后进行draw.</li></ul><p>trace snapshot:</p><p><img src="/image/ptr-comp/flyrefresh.PNG" alt="trace_flyrefresh"></p><p><strong>分析</strong>：每次拖动都会重新计算背景”山体”与”树木”的<code>Path</code>，造成了draw时间过长。效果不错，也是一个好的学习对象，相比<code>Yalantis</code>的下拉刷新性能上就差一些了，它的draw中的计算量太多。使用起来疑似有bug：拖动到顶部，无法再往上拖动，并且会出现拖动异常。</p><h3 id="6-SwipeRefreshLayout"><a href="#6-SwipeRefreshLayout" class="headerlink" title="6. SwipeRefreshLayout"></a>6. SwipeRefreshLayout</h3><p>滑动实现方式：内容固定，仅有顶部动效。</p><p>顶部动效实现方式：</p><ul><li><strong>上下移动</strong> <code>View.bringToFront()</code> + <code>View.offsetTopAndBottom()</code>.</li><li><strong>动效</strong> 通过移动偏移量计算弧形曲线的角度、三角形的位置，使用<code>drawArc</code>, <code>drawTriangle</code>将他们画到<code>Canvas</code>上。</li></ul><p>trace snapshot:</p><p><img src="/image/ptr-comp/swipe.PNG" alt="trace_swipe"></p><p><strong>分析</strong>：官方的下拉刷新组件，动画十分美观简洁，API构造清晰明了。但是为什么每次的移动都会有一段明显的measure时间呢？我研究了一下代码，发现罪魁祸首是<code>View.bringToFront()</code>，它在每一次滑动的时候都会对顶部动效视图调用这个函数。仔细追朔这个函数源码，它会走到下面这段代码中：</p><p><code>ViewGroup.java</code><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public void bringChildToFront(View child) &#123;</div><div class="line">    final int index = indexOfChild(child);</div><div class="line">    if (index &gt;= 0) &#123;</div><div class="line">        removeFromArray(index);</div><div class="line">        addInArray(child, mChildrenCount);</div><div class="line">        child.mParent = this;</div><div class="line">        requestLayout();</div><div class="line">        invalidate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>看，它是会触发<code>View.requestLayout()</code>的！这个函数会造成的后果我们在之前已经解释了，它会造成大量的UI线程开销。实际上我认为这个函数是没有调用的必要的，<code>SwipeRefreshLayout</code>明明在重写<code>onLayout()</code>的时候，header会被layout到child之上，没有必要再<code>bringToFront()</code>。</p><p>于是我copy了一份代码，将这一行注了(对应代码ptr-source-lib/src/main/java/com/android/support/SwipeRefreshLayout.java)，再次编译，measure时间确实没掉了，对功能毫无影响，性能却有了很大优化：</p><p><img src="/image/ptr-comp/swipe_new.PNG" alt="trace_swipe"></p><p>这样一来就不会每一次拉动，都会触发measure。若有同学知道这个<code>bringToFront()</code>在其中有其他我未探测到的功效，请issue指点:)</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table><thead><tr><th style="text-align:center">Repo</th><th style="text-align:center">性能</th><th style="text-align:center">拓展性</th><th style="text-align:center">综合建议</th></tr></thead><tbody><tr><td style="text-align:center"><a href="https://github.com/chrisbanes/Android-PullToRefresh" target="_blank" rel="external">Android-PullToRefresh</a></td><td style="text-align:center">★★★★★</td><td style="text-align:center">★★★</td><td style="text-align:center">由于作者不再维护，无法在gradle中配置，顶部视图难以拓展，不建议放入工程中使用</td></tr><tr><td style="text-align:center"><a href="https://github.com/liaohuqiu/android-Ultra-Pull-To-Refresh" target="_blank" rel="external">android-Ultra-Pull-To-Refresh</a></td><td style="text-align:center">★★★★★</td><td style="text-align:center">★★★★★</td><td style="text-align:center">如之前分析，<code>PtrClassicFrameLayout</code>性能有缺陷；建议使用<code>PtrFrameLayout</code>，性能较好。这套库自定义能力很强，建议使用。</td></tr><tr><td style="text-align:center"><a href="https://github.com/johannilsson/android-pulltorefresh" target="_blank" rel="external">android-pulltorefresh</a></td><td style="text-align:center">★</td><td style="text-align:center">★</td><td style="text-align:center">实现方式上有缺陷，拓展性也很差。优点就是代码非常简单，只能作为反面例子。</td></tr><tr><td style="text-align:center"><a href="https://github.com/Yalantis/Phoenix" target="_blank" rel="external">Phoenix</a></td><td style="text-align:center">★★★★</td><td style="text-align:center">★★</td><td style="text-align:center">效果非常好，性能不错，可惜比较难拓展顶部视图，为了适配布局padding造成了性能损失，有优化空间。可以作为学习与练手的对象。</td></tr><tr><td style="text-align:center"><a href="https://github.com/race604/FlyRefresh" target="_blank" rel="external">FlyRefresh</a></td><td style="text-align:center">★★★★</td><td style="text-align:center">★★</td><td style="text-align:center">效果很新颖，可惜的是顶部视图计算动效上开销太大，优化空间较少，可以作为学习与练手的对象。</td></tr><tr><td style="text-align:center"><a href="http://developer.android.com/reference/android/support/v4/widget/SwipeRefreshLayout.html" target="_blank" rel="external">SwipeRefreshLayout</a></td><td style="text-align:center">★★★</td><td style="text-align:center">★★</td><td style="text-align:center">官方出品，更新有保障，但是如上分析，其实性能上还是有点缺陷的，拓展性比较差，不建议放入工程中使用。</td></tr></tbody></table><h2 id="附录-知识点参考"><a href="#附录-知识点参考" class="headerlink" title="附录-知识点参考"></a>附录-知识点参考</h2><ol><li><a href="https://github.com/bboyfeiyu/android-tech-frontier/blob/master/issue-27/%E4%B8%BA%E4%BD%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%8A%A0%E9%80%9F%20-%20%E5%AE%89%E5%8D%93%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97.md" target="_blank" rel="external">为你的应用加速 - 安卓优化指南</a></li><li><a href="https://github.com/bboyfeiyu/android-tech-frontier/blob/b7e3f1715158fb9f2bbb0f349c4ec3da3db81342/issue-26/%E4%BD%BF%E7%94%A8Systrace%E5%88%86%E6%9E%90UI%E6%80%A7%E8%83%BD.md" target="_blank" rel="external">使用Systrace分析UI性能</a></li><li><a href="developers.android.com/tools/help/systrace.html">Systrace-文档</a></li><li><a href="http://blog.csdn.net/guolin_blog/article/details/9153747" target="_blank" rel="external">事件分发-郭霖csdn</a></li></ol></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Performance/" rel="tag"># Performance</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/mars-xlog/" rel="next" title="微信跨平台组件mars-xlog架构分析及迁移思路"><i class="fa fa-chevron-left"></i> 微信跨平台组件mars-xlog架构分析及迁移思路</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/android-storage/" rel="prev" title="Android存储挖坑记">Android存储挖坑记 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Desmond Yao</p><p class="site-description motion-element" itemprop="description">Android developer.</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">21</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">17</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/desmond1121" target="_blank" title="GitHub"><i class="fa fa-fw fa-globe"></i>GitHub</a> </span><span class="links-of-author-item"><a href="http://weibo.com/u/1901104743" target="_blank" title="Weibo"><i class="fa fa-fw fa-globe"></i>Weibo</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://kaedea.com/" title="Kaedea" target="_blank">Kaedea</a></li><li class="links-of-blogroll-item"><a href="http://yrom.net/" title="Yrom" target="_blank">Yrom</a></li><li class="links-of-blogroll-item"><a href="http://blog.zhaiyifan.cn/" title="MarkZhai" target="_blank">MarkZhai</a></li><li class="links-of-blogroll-item"><a href="http://abner-nimengbo.cn/" title="泥阿布" target="_blank">泥阿布</a></li><li class="links-of-blogroll-item"><a href="https://xiequan.info" title="谢权" target="_blank">谢权</a></li><li class="links-of-blogroll-item"><a href="http://rarnu.com/" title="何老师" target="_blank">何老师</a></li><li class="links-of-blogroll-item"><a href="http://fucknmb.com/" title="区长" target="_blank">区长</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Repo"><span class="nav-number">1.</span> <span class="nav-text">Repo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#拓展性"><span class="nav-number">2.</span> <span class="nav-text">拓展性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#易用性"><span class="nav-number">3.</span> <span class="nav-text">易用性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#触屏事件分发"><span class="nav-number">4.</span> <span class="nav-text">触屏事件分发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Chris-Banes’-ptr"><span class="nav-number">4.1.</span> <span class="nav-text">1. Chris Banes’ ptr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-SwipeRefreshLayout"><span class="nav-number">4.2.</span> <span class="nav-text">2. SwipeRefreshLayout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Liaohuqiu’s-ptr"><span class="nav-number">4.3.</span> <span class="nav-text">3. Liaohuqiu’s ptr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-其他库"><span class="nav-number">4.4.</span> <span class="nav-text">3.其他库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Chris-Banes’s-Ptr"><span class="nav-number">4.5.</span> <span class="nav-text">1. Chris Banes’s Ptr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-liaohuqiu’s-Ptr"><span class="nav-number">4.6.</span> <span class="nav-text">2. liaohuqiu’s Ptr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-johannilsson’s-Ptr"><span class="nav-number">4.7.</span> <span class="nav-text">3. johannilsson’s Ptr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Yalantis’s-Ptr"><span class="nav-number">4.8.</span> <span class="nav-text">4. Yalantis’s Ptr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-race604’s-Ptr"><span class="nav-number">4.9.</span> <span class="nav-text">5. race604’s Ptr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-SwipeRefreshLayout"><span class="nav-number">4.10.</span> <span class="nav-text">6. SwipeRefreshLayout</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录-知识点参考"><span class="nav-number">6.</span> <span class="nav-text">附录-知识点参考</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2017</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Desmond Yao</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script></body></html>