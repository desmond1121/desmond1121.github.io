<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/luffy.img?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/luffy.img?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/luffy.img?v=5.1.3"><link rel="mask-icon" href="/images/luffy.img?v=5.1.3" color="#222"><meta name="keywords" content="Android,"><meta name="description" content="最近在搞Android存储相关的业务，什么Internal/External/Primary/Secondary搞得我都看懵了，国内也没什么好的文章系统的讲这个，我就挖挖各类资料，整理一下。"><meta name="keywords" content="Android"><meta property="og:type" content="article"><meta property="og:title" content="Android存储挖坑记"><meta property="og:url" content="http://blog.desmondyao.com/android-storage/index.html"><meta property="og:site_name" content="Desmond&#39;s Blog"><meta property="og:description" content="最近在搞Android存储相关的业务，什么Internal/External/Primary/Secondary搞得我都看懵了，国内也没什么好的文章系统的讲这个，我就挖挖各类资料，整理一下。"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2017-11-06T12:30:53.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Android存储挖坑记"><meta name="twitter:description" content="最近在搞Android存储相关的业务，什么Internal/External/Primary/Secondary搞得我都看懵了，国内也没什么好的文章系统的讲这个，我就挖挖各类资料，整理一下。"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://blog.desmondyao.com/android-storage/"><title>Android存储挖坑记 | Desmond's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Desmond's Blog</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Focus on Java, Android, React Native.</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://blog.desmondyao.com/android-storage/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Desmond Yao"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Desmond's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Android存储挖坑记</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-06T20:30:53+08:00">2017-11-06</time></span></div></header><div class="post-body" itemprop="articleBody"><p>最近在搞Android存储相关的业务，什么Internal/External/Primary/Secondary搞得我都看懵了，国内也没什么好的文章系统的讲这个，我就挖挖各类资料，整理一下。</p><a id="more"></a><h2 id="1-Internal-vs-External"><a href="#1-Internal-vs-External" class="headerlink" title="1. Internal vs External"></a>1. Internal vs External</h2><p>对于Internal Storage 与 External Storage，官方文档上有这么一段话，描述得很详细了，我翻译了一段下来：</p><blockquote><p>所有的Android设备都有两块存储区域：Internal Storage和External Storage。它们的名称来源于早期的Android系统，那时候大家的手机都内置(Permanent)一块较小存储板（即Internal Storage），并配上一个的外置的(Removable)储存卡（即External Storage）。后来部分手机开始将最初定义的“Internal Storage”，即内置存储，分成Internal和External两部分。这样一来就算没有外置储存，手机也有Internal和External两块存储区域。这两块存储区域的区别是：</p><table><thead><tr><th style="text-align:center"></th><th>Internal Storage</th><th style="text-align:center">External Storage</th></tr></thead><tbody><tr><td style="text-align:center">可信度</td><td>永远可用(Permanent)</td><td style="text-align:center">可能不可用，最典型的当设备作为USB存储被mount时不可用</td></tr><tr><td style="text-align:center">访问权限</td><td>App存储内容仅App本身（或共享uid的App）可访问（Root除外）</td><td style="text-align:center">App存储内容全局可读</td></tr><tr><td style="text-align:center">内容持久</td><td>App存储内容随App卸载而消失</td><td style="text-align:center">当App卸载时，只有存在<code>getExternalFilesDir()</code>路径下的文件会消失</td></tr><tr><td style="text-align:center">适应情况</td><td>存储内容仅App自己访问时的最佳选择</td><td style="text-align:center">存储内容希望与其他App共享或传到电脑上，但是不想申请任何权限时的最佳选择</td></tr></tbody></table><p>注：此处讨论的访问权限是应用路径下的权限。</p></blockquote><p>总结下来，External存储区域有几个好处：</p><ol><li>可以传到电脑上；</li><li>可以与其他app共享；</li><li>在4.4之后的App路径(<code>Android/data/包名</code>)下读写不需任何权限；</li><li>存在App路径之外的文件不会随App卸载。</li></ol><p>相应的，也有几个缺点：</p><ol><li>可能不可用；</li><li>会被其他应用读到;</li><li>在非App路径下写、修改文件需要权限。</li></ol><h3 id="1-1-External-Storage的权限"><a href="#1-1-External-Storage的权限" class="headerlink" title="1.1 External Storage的权限"></a>1.1 External Storage的权限</h3><p>在Internal Storage的App路径下（<code>/data/data/包名</code>下)，App的读写操作无需任何权限，我们只需要总结一下External Storage的情况：</p><table><thead><tr><th style="text-align:center">Android版本</th><th style="text-align:center">读</th><th style="text-align:center">写</th></tr></thead><tbody><tr><td style="text-align:center">4.4以下</td><td style="text-align:center">无需权限</td><td style="text-align:center">需要申请<code>WRITE_EXTERNAL_STORAGE</code></td></tr><tr><td style="text-align:center">4.4及以上</td><td style="text-align:center">无需权限</td><td style="text-align:center">在App目录之外写，需要申请<code>WRITE_EXTERNAL_STORAGE</code></td></tr></tbody></table><p>关于读External的权限，在<a href="http://developer.android.com/training/basics/data-storage/files.html#GetWritePermission" target="_blank" rel="external">Android Developer</a>上有这样一段话:</p><blockquote><p>目前，所有App都可以读External存储而不需要任何权限，这一点可能会在未来做出改变。如果你希望读External存储，那最好申请一下<code>READ_EXTERNAL_STORAGE</code>权限。另外，写权限已经默认包含了读权限了。</p></blockquote><p>正常情况下，你用任何文件管理器，点开的根目录就是你的External存储。你可以到它下面的应用目录，你会发现，就算是各个包名下的文件，你也是看得到的。</p><h3 id="1-2-多用户"><a href="#1-2-多用户" class="headerlink" title="1.2 多用户"></a>1.2 多用户</h3><p>在4.2及以上的Android系统中引入了多用户机制。你可能会发现在存储路径后面有’0’/‘1’的字样（如<code>/storage/emulated/0/</code>），这后面的数字表示用户。主用户后面为0。</p><h2 id="2-Primary-vs-Secondary"><a href="#2-Primary-vs-Secondary" class="headerlink" title="2. Primary vs Secondary"></a>2. Primary vs Secondary</h2><p>这个Primary和Secondary是怎么来的呢？实际上最开始Android也没有考虑这个区分，但是后来有一个情况发生了，就是上面所说到的：</p><blockquote><p>后来部分手机开始将最初定义的“Internal Storage”，即内置存储，分成Internal和External两部分。</p></blockquote><p>那么如果这个时候手机再插入sd卡，那不是有多个External Storage了吗？</p><p>这个时候，从Internal Storage里面分出来的那块“External Storage”我们称之为<strong>主存储(Primary Storage)</strong>，插入的外置储存称之为<strong>副存储(Secondary Storage)</strong>。</p><p><strong>主存储路径</strong>的获取方式非常简单，可以通过<code>Environment.getExternalStorageDirectory()</code>或者<code>Context.getExternalFilesDir(null)</code>来获取。</p><p><strong>副存储路径</strong>在4.4及以上的Android系统中，可以使用<code>Context.getExternalFilesDirs(null)</code>(注意最后多了一个’s’)，它返回的是一个字符串数组。第0个就是主存储路径，第1个是副存储路径（如果有的话）。</p><p>在<strong>4.4及以下系统中</strong>，的副存储的获取方式就是一个<strong><em>大坑</em></strong>了，一个一个介绍一下笔者看到过的方法。</p><h3 id="2-1-副储存路径-StorageManager"><a href="#2-1-副储存路径-StorageManager" class="headerlink" title="2.1 副储存路径-StorageManager"></a>2.1 副储存路径-StorageManager</h3><p>在Android中可以通过<code>context.getSystemService(STORAGE_SERVICE)</code>来获取到<code>StorageManager</code>，但是很可惜的是，它里面有价值的方法都是hide的。。</p><p>庆幸的是还有反射。我们可以调用<code>getVolumeList()</code>函数，这个返回的List里面，主存储是第0个，副存储（如果有的话）是第1个。<br>你可以看到<code>Environment.getExternalStorageDirectory()</code>里面就是用它实现的，可以说这个方法是目前最稳妥的。它通过系统的<code>MountService</code>来获取已mount上来的设备，并且能够通过<code>StorageVolume</code>知道该存储是否<code>removable</code>、是否是<code>emulated</code>、mount状态等等。</p><p>涉及到存储，由于Android rom千奇百怪，不可能是万全的。如果反射出来的方法缺少变量、方法，或者有别的什么坑，那只能试一下其他方法来保底。</p><p><strong>靠谱程度：99%</strong></p><h3 id="2-2-副存储路径-读配置xml"><a href="#2-2-副存储路径-读配置xml" class="headerlink" title="2.2 副存储路径-读配置xml"></a>2.2 副存储路径-读配置xml</h3><p>读<code>com.android.internal.R.xml.storage_list.xml</code>可以获取到系统的VolumeList，但是这种方法是行不通的，我们可以从源码中看看。</p><p>在6.0以前的<code>MountService</code>上面看到<code>readStorageList()</code>这个函数，它在构造函数里面就会被调用，就是在读取这个xml文件。但是我们可以看到它并没有在<code>Volume</code>改变的时候被动态写入。</p><p>并且参考<a href="https://source.android.com/devices/storage/config-example.html" target="_blank" rel="external">AOSP Document</a>,这个xml文件里面存储的就是厂商配置的分区，它<strong>根本无法更新removable存储的热插拔信息</strong>。</p><blockquote><p>注意：<strong>这个xml在6.0被移除了(参考<a href="https://source.android.com/devices/storage/config-example.html" target="_blank" rel="external">AOSP Document</a>)</strong></p></blockquote><p><strong>靠谱程度：0%</strong></p><h3 id="2-3-副存储路径-mount命令"><a href="#2-3-副存储路径-mount命令" class="headerlink" title="2.3 副存储路径-mount命令"></a>2.3 副存储路径-mount命令</h3><p>执行Linux shell下的mount命令，遍历每个mount点，从中找到副存储。</p><p>目前，它确实能够列出副存储。但是同时会列出很多很多mount点，包括系统mount点，目前好像没有已知的靠谱方法能够从中准确找出副存储。副存储的命名是没有规律的，枚举排除系统mount点的方法不能够100%确保准确性。</p><p><strong>靠谱程度：10%</strong></p><h3 id="2-4-副存储路径-读vold-fstab文件"><a href="#2-4-副存储路径-读vold-fstab文件" class="headerlink" title="2.4 副存储路径-读vold.fstab文件"></a>2.4 副存储路径-读vold.fstab文件</h3><p>解析<code>/etc/void.fstab</code>，从中找到副存储位置。</p><p><strong>Vold(Volume Daemon)</strong>是<code>ServiceManager</code>与kernel层之间的桥梁，它对于Volume的信息维护在<code>/etc/vold.fstab</code>中。</p><p>一听就是一个奇怪的方法，文件位置、信息也可能被各类厂商篡改，还可能存在瞬时不一致的情况，不要考虑它。有兴趣的同学可以研究一下<a href="http://www.slideshare.net/wiliwe/android-storage-vold" target="_blank" rel="external">android-storage-vold</a>。</p><p><strong>靠谱程度：0%</strong></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总结出Android手机目前的几种存储方式：</p><h3 id="在6-0之前"><a href="#在6-0之前" class="headerlink" title="在6.0之前"></a>在6.0之前</h3><p>6.0之前，所有的存储类型都是<a href="https://source.android.com/devices/storage/traditional.html" target="_blank" rel="external">Traditional Storage</a>。它支持多用户、模拟External存储。由于是MBR分区，存储上线为2TB。</p><ol><li><p><strong>Physical Primary</strong> 最原始的样子是只有机身自带的Internal存储和以External存在的外置存储，这时候只有一个主存储，并且它是Physical的。</p></li><li><p><strong>Emulated Primary (Optional Physical Secondary)</strong> 之前所说，从Internal Storage分出一块来给External Storage。这块存储空间就是在Permanent存储版中”模拟“上去的。所以你可以看到主存储经常有<code>emulated</code>字样。 如果这时候还能再插SD卡，则会多一个Physical的Secondary存储。</p></li></ol><h3 id="在6-0之后"><a href="#在6-0之后" class="headerlink" title="在6.0之后"></a>在6.0之后</h3><p>正常情况下，它的存储方式与之前的两种相同，不过多了一种新的存储方式：<a href="https://source.android.com/devices/storage/adoptable.html" target="_blank" rel="external">Adoptable Storage</a></p><h4 id="Adoptable-Storage"><a href="#Adoptable-Storage" class="headerlink" title="Adoptable Storage"></a>Adoptable Storage</h4><p>由于External Storage的缺点（有时不可用，存储内容没有被保护），在6.0之后多出了<code>Adoptable</code>存储方式。</p><p>当Android系统<code>Adopt</code>了一块External存储区域的时候，它会被视为Internal Storage，同时会被格式化与加密。格式化之后是GPT分区，存储上线为9ZB。</p><p>当你在一个支持<code>Adoptable Storage</code>的手机上插入一个sd卡，它会提示你是否将这个sd卡格式化并用作Internal Storage，或者正常作为External Storage使用。</p><p>推荐一篇文章：</p><p><a href="https://commonsware.com/blog/2014/04/07/storage-situation-internal-storage.html" target="_blank" rel="external">CommonsWare’s post</a>，从不同角度诠释了Internal&amp;External Storage， 非常不错！</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Android/" rel="tag"># Android</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/ptr-comp/" rel="next" title="安卓下拉刷新开源库对比"><i class="fa fa-chevron-left"></i> 安卓下拉刷新开源库对比</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/android-bad-window-token/" rel="prev" title="一个诡异的BadTokenException">一个诡异的BadTokenException <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Desmond Yao</p><p class="site-description motion-element" itemprop="description">Android developer.</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">21</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">17</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Internal-vs-External"><span class="nav-number">1.</span> <span class="nav-text">1. Internal vs External</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-External-Storage的权限"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 External Storage的权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-多用户"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 多用户</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Primary-vs-Secondary"><span class="nav-number">2.</span> <span class="nav-text">2. Primary vs Secondary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-副储存路径-StorageManager"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 副储存路径-StorageManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-副存储路径-读配置xml"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 副存储路径-读配置xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-副存储路径-mount命令"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 副存储路径-mount命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-副存储路径-读vold-fstab文件"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 副存储路径-读vold.fstab文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在6-0之前"><span class="nav-number">3.1.</span> <span class="nav-text">在6.0之前</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在6-0之后"><span class="nav-number">3.2.</span> <span class="nav-text">在6.0之后</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Adoptable-Storage"><span class="nav-number">3.2.1.</span> <span class="nav-text">Adoptable Storage</span></a></li></ol></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2017</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Desmond Yao</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script></body></html>